{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetGuard - Cadastro de Animal</title>
  <link rel="stylesheet" href="{% static 'petguard/styles.css' %}">
  <link rel="stylesheet" href="{% static 'petguard/addAnimal.css' %}">
</head>
<body>

  <header>
    <div class="header-content">
      <div class="logo-nome">
        <img src="{% static 'petguard/petlogobranco.png' %}" class="logo" id="logo">
      </div>
      <div class="profile-container">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Perfil" class="profile-icon" id="profileIcon">
        <div class="profile-menu" id="profileMenu">
          <p class="profile-name">Olá, {{ user }}!</p>
          <a href="#">Meu Perfil</a>
          {% if is_admin %}
            <a href="http://127.0.0.1:8000/admin/">Cadastrar Usuário</a>
          {% endif %}
          <a href="{% url 'logout' %}">Sair</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <form method="POST" action="">
        {% csrf_token %}
        <div class="animal-info">
          <div class="animal-foto">
            <img src="{% static 'petguard/icone-gato.png' %}" alt="Foto do animal">
          </div>

          <div class="dados">
            {% if animal %}
              <p><strong>ID:</strong> {{ animal.id }}</p>
            {% endif %}

            <div class="idade">
              <label>Idade:</label>
              <select name="anos">
                {% for i in anos %}
                  <option value="{{ i }}" {% if animal and animal.anos == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
              </select>
              <span>ano(s)</span>

              <select name="meses">
                {% for i in meses %}
                  <option value="{{ i }}" {% if animal and animal.meses == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
              </select>
              <span>mês(es)</span>
            </div>

            <label>Apelido:</label>
            <input type="text" name="apelido" placeholder="Apelido" value="{{ animal.apelido|default:'' }}">

            <label>Espécie:</label>
            <select name="especie" id="especieSelect" required>
              <option value="">Selecione</option>
              {% for especie in especies %}
                <option value="{{ especie.id }}" {% if animal and animal.especie.id == especie.id %}selected{% endif %}>
                  {{ especie.nome }}
                </option>
              {% endfor %}
            </select>

            <label>Raça:</label>
            <select name="raca" id="racaSelect" onchange="handleRacaChange(this)" required>
              <option value="">Selecione uma espécie primeiro...</option>
              {% if animal and racas %}
                {% for raca in racas %}
                  <option value="{{ raca.id }}" {% if animal and animal.raca.id == raca.id %}selected{% endif %}>
                    {{ raca.nome }}
                  </option>
                {% endfor %}
              {% endif %}
              <option value="nova">➕ Adicionar nova raça</option>
            </select>

            <div id="novaRacaDiv" style="display: none; margin-top: 10px;">
              <input type="text" id="novaRacaInput" name="nova_raca" placeholder="Digite o nome da nova raça...">
            </div>

            <label>Status:</label>
            <select id="status" name="status" class="form-select" style="width: 200px;">
              <option value="disponivel" {% if animal.status == "disponivel" %}selected{% endif %}>Disponível</option>
              <option value="em tratamento" {% if animal.status == "em tratamento" %}selected{% endif %}>Em tratamento</option>
              <option value="adotado" {% if animal.status == "adotado" %}selected{% endif %}>Adotado</option>
            </select>
          </div>
        </div>

        <label style="margin-top: 20px;">Observações:</label>
        <textarea name="observacoes" placeholder="Digite as observações...">{{ animal.observacoes|default:'' }}</textarea>

        <div class="botoes">
          <button type="submit" class="btn-salvar">Salvar</button>
          <a href="{% url 'index' %}" class="btn-cancelar">Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Mostrar campo "nova raça" se selecionado
    function handleRacaChange(select) {
      const novaRacaDiv = document.getElementById("novaRacaDiv");
      if (select.value === "nova") {
        novaRacaDiv.style.display = "block";
      } else {
        novaRacaDiv.style.display = "none";
        document.getElementById("novaRacaInput").value = "";
      }
    }

    // Atualiza raças dinamicamente conforme a espécie selecionada
    document.getElementById("especieSelect").addEventListener("change", function() {
      const especieId = this.value;
      const racaSelect = document.getElementById("racaSelect");

      racaSelect.innerHTML = '<option value="">Carregando...</option>';

      if (especieId) {
        fetch(`/racas/${especieId}/`)
          .then(response => response.json())
          .then(data => {
            racaSelect.innerHTML = '<option value="">Selecione</option>';
            data.forEach(raca => {
              const option = document.createElement("option");
              option.value = raca.id;
              option.textContent = raca.nome;
              racaSelect.appendChild(option);
            });
            // Adiciona novamente a opção de nova raça
            const novaOption = document.createElement("option");
            novaOption.value = "nova";
            novaOption.textContent = "➕ Adicionar nova raça";
            racaSelect.appendChild(novaOption);
          })
          .catch(() => {
            racaSelect.innerHTML = '<option value="">Erro ao carregar raças</option>';
          });
      } else {
        racaSelect.innerHTML = '<option value="">Selecione uma espécie primeiro...</option>';
      }
    });
  </script>

</body>
</html>
