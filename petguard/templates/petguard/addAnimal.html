{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetGuard - Cadastro de Animal</title>
  <link rel="stylesheet" href="{% static 'petguard/styles.css' %}">
  <link rel="stylesheet" href="{% static 'petguard/addAnimal.css' %}">
  <style>
    .foto-animal-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .foto-preview {
      width: 180px;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
      transition: 0.3s;
    }
    .foto-preview:hover {
      opacity: 0.8;
      border-color: #4CAF50;
    }
    .foto-label {
      font-size: 0.95rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #foto {
      display: none;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <div class="logo-nome">
        <img src="{% static 'petguard/petlogobranco.png' %}" class="logo" id="logo">
      </div>
      <div class="profile-container">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Perfil" class="profile-icon" id="profileIcon">
        <div class="profile-menu" id="profileMenu">
          <p class="profile-name">Ol√°, {{ user }}!</p>
          <a href="#">Meu Perfil</a>
          {% if is_admin %}
            <a href="http://127.0.0.1:8000/admin/">Cadastrar Usu√°rio</a>
          {% endif %}
          <a href="{% url 'logout' %}">Sair</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <form method="POST" action="" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="animal-info">
          <div class="foto-animal-container" onclick="document.getElementById('foto').click()">
            {% if animal and animal.foto %}
              <img id="fotoPreview" src="{{ animal.foto.url }}" alt="Foto do animal" class="foto-preview">
            {% else %}
              <img id="fotoPreview" src="{% static 'petguard/icone-gato.png' %}" alt="Foto do animal" class="foto-preview">
            {% endif %}
            <label for="foto" class="foto-label">üì∏ Clique na imagem para trocar</label>
            <input type="file" name="foto" id="foto" accept="image/*" onchange="previewFoto(event)">
          </div>

          <div class="dados">
            {% if animal %}
              <p><strong>ID:</strong> {{ animal.id }}</p>
            {% endif %}

            <div class="idade">
              <label>Idade:</label>
              <select name="anos">
                {% for i in anos %}
                  <option value="{{ i }}" {% if animal and animal.anos == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
              </select>
              <span>ano(s)</span>

              <select name="meses">
                {% for i in meses %}
                  <option value="{{ i }}" {% if animal and animal.meses == i %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
              </select>
              <span>m√™s(es)</span>
            </div>

            <label>Apelido:</label>
            <input type="text" name="apelido" placeholder="Apelido" value="{{ animal.apelido|default:'' }}">

            <label>Esp√©cie:</label>
            <select name="especie" id="especieSelect" required>
              <option value="">Selecione</option>
              {% for especie in especies %}
                <option value="{{ especie.id }}" {% if animal and animal.especie.id == especie.id %}selected{% endif %}>
                  {{ especie.nome }}
                </option>
              {% endfor %}
            </select>

            <label>Ra√ßa:</label>
            <select name="raca" id="racaSelect" onchange="handleRacaChange(this)" required>
              <option value="">Selecione uma esp√©cie primeiro...</option>
              {% if animal and racas %}
                {% for raca in racas %}
                  <option value="{{ raca.id }}" {% if animal and animal.raca.id == raca.id %}selected{% endif %}>
                    {{ raca.nome }}
                  </option>
                {% endfor %}
              {% endif %}
              <option value="nova">‚ûï Adicionar nova ra√ßa</option>
            </select>

            <div id="novaRacaDiv" style="display: none; margin-top: 10px;">
              <input type="text" id="novaRacaInput" name="nova_raca" placeholder="Digite o nome da nova ra√ßa...">
            </div>

            <label>Status:</label>
            <select id="status" name="status" class="form-select" style="width: 200px;">
              <option value="disponivel" {% if animal.status == "disponivel" %}selected{% endif %}>Dispon√≠vel</option>
              <option value="em tratamento" {% if animal.status == "em tratamento" %}selected{% endif %}>Em tratamento</option>
              <option value="adotado" {% if animal.status == "adotado" %}selected{% endif %}>Adotado</option>
            </select>
          </div>
        </div>

        <label style="margin-top: 20px;">Observa√ß√µes:</label>
        <textarea name="observacoes" placeholder="Digite as observa√ß√µes...">{{ animal.observacoes|default:'' }}</textarea>

        <div class="botoes">
          <button type="submit" class="btn-salvar">Salvar</button>
          <a href="{% url 'index' %}" class="btn-cancelar">Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    function handleRacaChange(select) {
      const novaRacaDiv = document.getElementById("novaRacaDiv");
      if (select.value === "nova") {
        novaRacaDiv.style.display = "block";
      } else {
        novaRacaDiv.style.display = "none";
        document.getElementById("novaRacaInput").value = "";
      }
    }

    document.getElementById("especieSelect").addEventListener("change", function() {
      const especieId = this.value;
      const racaSelect = document.getElementById("racaSelect");
      racaSelect.innerHTML = '<option value="">Carregando...</option>';

      if (especieId) {
        fetch(`/racas/${especieId}/`)
          .then(response => response.json())
          .then(data => {
            racaSelect.innerHTML = '<option value="">Selecione</option>';
            data.forEach(raca => {
              const option = document.createElement("option");
              option.value = raca.id;
              option.textContent = raca.nome;
              racaSelect.appendChild(option);
            });
            const novaOption = document.createElement("option");
            novaOption.value = "nova";
            novaOption.textContent = "‚ûï Adicionar nova ra√ßa";
            racaSelect.appendChild(novaOption);
          })
          .catch(() => {
            racaSelect.innerHTML = '<option value="">Erro ao carregar ra√ßas</option>';
          });
      } else {
        racaSelect.innerHTML = '<option value="">Selecione uma esp√©cie primeiro...</option>';
      }
    });

    // Preview da imagem escolhida
    function previewFoto(event) {
      const fotoPreview = document.getElementById('fotoPreview');
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          fotoPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }
  </script>

</body>
</html>
